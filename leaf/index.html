<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Public Notes</title>
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #e6e6e6;
      --accent: #4caf7d;
      --note-bg: #1b1b1b;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 20px;
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }

    h2 { color: var(--accent); margin-top: 0; }

    .note {
      padding: 12px;
      border: 1px solid #4442;
      border-radius: 8px;
      background: var(--note-bg);
      white-space: pre-wrap;
      word-wrap: break-word;
      transition: background 0.3s;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #6664;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
      background: var(--card);
      color: var(--text);
      transition: background 0.3s, color 0.3s, border 0.3s;
    }

    textarea {
      min-height: 300px;
      resize: vertical;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.3s;
    }
    .btn:hover { filter: brightness(0.9); }

    #editor { display: none; margin-top: 20px; }
    #status { font-size: 0.9rem; color: #888; margin: 10px 0; }

    /* Overlays */
    #overlay, #errorOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 10; }

    /* Login & Error Modals */
    #loginPanel, #errorDialog {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: var(--card);
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      padding: 20px;
      z-index: 20;
      display: none;
      animation: fadeIn 0.3s ease;
      transition: background 0.3s, color 0.3s;
      text-align: center;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }

    #loginPanel h3 { margin: 10px 0 6px; font-size: 1.1rem; color: var(--accent); }
    .close-btn { float: right; background: none; border: none; color: #999; font-size: 1.3rem; cursor: pointer; }

    .error-icon { font-size: 3rem; color: red; margin-bottom: 10px; }
    .error-code { color: red; font-weight: bold; margin-top: 8px; }
    .top-controls { display: flex; gap: 10px; margin-bottom: 10px; }

    /* Shake animation */
    @keyframes shake {
      0%, 100% { transform: translate(-50%, -50%); }
      20%, 60% { transform: translate(calc(-50% - 10px), -50%); }
      40%, 80% { transform: translate(calc(-50% + 10px), -50%); }
    }
    .shake { animation: shake 0.4s; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Public Note</h2>
    <div class="top-controls">
      <button id="showLoginBtn" class="btn">Log in</button>
      <button id="toggleDark" class="btn">‚òÄÔ∏è Light Mode</button>
    </div>
    <div id="publicNote" class="note">Loading‚Ä¶</div>
    <div id="status">Not signed in</div>

    <div id="editor">
      <textarea id="editorContent"></textarea>
      <button id="btnSave" class="btn">Save</button>
      <button id="btnSignOut" class="btn">Sign out</button>
    </div>
  </div>

  <div id="overlay"></div>

  <div id="loginPanel">
    <button class="close-btn" id="closeLogin">&times;</button>
    <h3>Email Login</h3>
    <input id="emailInput" type="text" placeholder="Email">
    <input id="pwdInput" type="password" placeholder="Password">
    <button id="btnEmailLogin" class="btn">Sign in</button>
    <h3>Quick Unlock</h3>
    <input id="simplePwd" type="password" placeholder="Password">
    <button id="btnSimpleLogin" class="btn">Unlock</button>
  </div>

  <div id="errorOverlay"></div>
  <div id="errorDialog">
    <div class="error-icon">‚ùå</div>
    <div id="errorMessage">Something went wrong</div>
    <div id="errorCode" class="error-code"></div>
    <button id="closeError" class="btn">Close</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACgn0fMfuCT3-kbDl7eoQBW--4Vw6UMeE",
      authDomain: "server-notes67.firebaseapp.com",
      projectId: "server-notes67",
      storageBucket: "server-notes67.firebasestorage.app",
      messagingSenderId: "442575262453",
      appId: "1:442575262453:web:1425831515c1eae4aaabbc",
      measurementId: "G-PYF71QHYGW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const publicNoteEl = document.getElementById("publicNote");
    const statusEl = document.getElementById("status");
    const editor = document.getElementById("editor");
    const editorContent = document.getElementById("editorContent");
    const btnSave = document.getElementById("btnSave");

    const loginPanel = document.getElementById("loginPanel");
    const overlay = document.getElementById("overlay");

    const errorOverlay = document.getElementById("errorOverlay");
    const errorDialog = document.getElementById("errorDialog");
    const errorMessage = document.getElementById("errorMessage");
    const errorCode = document.getElementById("errorCode");

    const noteDoc = doc(db, "notes", "public");

    function showError(message, code) {
      errorMessage.textContent = message;
      errorCode.textContent = "Error code: " + code;
      errorOverlay.style.display = "block";
      errorDialog.style.display = "block";

      errorDialog.classList.remove("shake");
      void errorDialog.offsetWidth;
      errorDialog.classList.add("shake");

      loginPanel.classList.remove("shake");
      void loginPanel.offsetWidth;
      loginPanel.classList.add("shake");
    }

    function hideError() { errorOverlay.style.display = "none"; errorDialog.style.display = "none"; }

    document.getElementById("closeError").addEventListener("click", hideError);
    errorOverlay.addEventListener("click", hideError);

    onSnapshot(noteDoc, (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        publicNoteEl.textContent = data.content || "";
        if (editor.style.display !== "none") editorContent.value = data.content || "";
      } else { publicNoteEl.textContent = "(no note yet)"; }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        statusEl.textContent = "Signed in";
        editor.style.display = "block";
        hideLogin();
        getDoc(noteDoc).then(snap => { editorContent.value = snap.exists() ? snap.data().content || "" : ""; });
      } else { statusEl.textContent = "Not signed in"; editor.style.display = "none"; }
    });

    document.getElementById("btnEmailLogin").addEventListener("click", async () => {
      const email = document.getElementById("emailInput").value.trim();
      const pwd = document.getElementById("pwdInput").value;
      if (!email || !pwd) { showError("Enter email and password", "missing_fields"); return; }
      try { await signInWithEmailAndPassword(auth, email, pwd); } 
      catch (err) { showError("Login failed: "+err.message, err.code || "auth_error"); }
    });

    document.getElementById("btnSimpleLogin").addEventListener("click", async () => {
      const p = document.getElementById("simplePwd").value;
      if (p === "79204") {
        try { await signInAnonymously(auth); } 
        catch (err) { showError("Unlock failed: "+err.message, err.code || "anon_login_error"); }
      } else { showError("Wrong password", "no_correct_pass"); }
    });

    btnSave.addEventListener("click", async () => { await setDoc(noteDoc, { content: editorContent.value }); });

    document.getElementById("btnSignOut").addEventListener("click", () => { signOut(auth); });

    function showLogin() { overlay.style.display = "block"; loginPanel.style.display = "block"; }
    function hideLogin() { overlay.style.display = "none"; loginPanel.style.display = "none"; }
    document.getElementById("showLoginBtn").addEventListener("click", showLogin);
    document.getElementById("closeLogin").addEventListener("click", hideLogin);
    overlay.addEventListener("click", hideLogin);

    const toggleDark = document.getElementById("toggleDark");
    toggleDark.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      toggleDark.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
    });
  </script>
</body>
</html>
